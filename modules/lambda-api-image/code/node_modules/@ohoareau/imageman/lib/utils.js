"use strict";
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];
    result["default"] = mod;
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
const availableTargetTypes = __importStar(require("./target-types"));
const availableSourceTypes = __importStar(require("./source-types"));
function parseDsn(string) {
    const [type, location = undefined] = string.split(/:\/\//);
    return { type: location ? type : 'file', location: location || type };
}
exports.parseDsn = parseDsn;
async function applyFormat(img, format) {
    switch (format === null || format === void 0 ? void 0 : format.type) {
        case 'png': return img.png(format.options);
        case 'jpeg': return img.jpeg(format.options);
        case 'gif': return img.gif(format.options);
        case 'webp': return img.webp(format.options);
        case 'tiff': return img.tiff(format.options);
        case 'avif': return img.avif(format.options);
        case 'heif': return img.heif(format.options);
        case 'raw': return img.raw(format.options);
        default: return img;
    }
}
exports.applyFormat = applyFormat;
async function describeTarget(output, format = undefined) {
    if (!output)
        throw new Error(`Output is empty`);
    if ('string' === typeof output) {
        switch (output) {
            case 'stdout':
                output = 'stdout://stdout';
                break;
            case 'buffer':
                output = 'buffer://buffer';
                break;
            default:
                if (-1 === output.indexOf('://')) {
                    output = `file://${output}`;
                }
                break;
        }
        output = parseDsn(output);
    }
    const detectedFormatName = detectFormatFromFileName(output.location);
    return { format: format || (detectedFormatName ? { type: detectedFormatName } : output.format), target: { ...output } };
}
exports.describeTarget = describeTarget;
async function save(img, target, targetTypes = {}) {
    const allTargetTypes = { ...availableTargetTypes, ...targetTypes };
    const targetType = allTargetTypes[target === null || target === void 0 ? void 0 : target.type];
    if (!targetType)
        throw new Error(`Unsupported target type '${target === null || target === void 0 ? void 0 : target.type}'`);
    return targetType(img, target);
}
exports.save = save;
async function fetch(input, sourceTypes = {}) {
    if (!input)
        throw new Error(`Input is empty`);
    if (Buffer.isBuffer(input))
        return input;
    if ('string' === typeof input) {
        if (-1 === input.indexOf('://')) {
            input = `file://${input}`;
        }
        input = parseDsn(input);
    }
    const allSourceTypes = { ...availableSourceTypes, ...sourceTypes };
    const sourceType = allSourceTypes[input === null || input === void 0 ? void 0 : input.type];
    if (!sourceType)
        throw new Error(`Unsupported source type '${input === null || input === void 0 ? void 0 : input.type}'`);
    return sourceType(input, sourceType);
}
exports.fetch = fetch;
exports.extensions = {
    jpg: 'jpg',
    jpeg: 'jpeg',
    png: 'png',
    gif: 'gif',
    webp: 'webp',
    tiff: 'tiff',
    avif: 'avif',
    heic: 'heif',
    heif: 'heif',
    raw: 'raw',
};
function detectFormatFromFileName(name) {
    if (!name)
        return undefined;
    return exports.extensions[(name.slice(name.lastIndexOf('.') + 1) || '').toLowerCase()] || undefined;
}
exports.detectFormatFromFileName = detectFormatFromFileName;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvdXRpbHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUEscUVBQXVEO0FBQ3ZELHFFQUF1RDtBQUd2RCxTQUFnQixRQUFRLENBQUMsTUFBYztJQUNuQyxNQUFNLENBQUMsSUFBSSxFQUFFLFFBQVEsR0FBRyxTQUFTLENBQUMsR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQzNELE9BQU8sRUFBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLE1BQU0sRUFBRSxRQUFRLEVBQUUsUUFBUSxJQUFJLElBQUksRUFBQyxDQUFDO0FBQ3hFLENBQUM7QUFIRCw0QkFHQztBQUVNLEtBQUssVUFBVSxXQUFXLENBQUMsR0FBUSxFQUFFLE1BQWM7SUFDdEQsUUFBUSxNQUFNLGFBQU4sTUFBTSx1QkFBTixNQUFNLENBQUUsSUFBSSxFQUFFO1FBQ2xCLEtBQUssS0FBSyxDQUFDLENBQUMsT0FBUSxHQUFHLENBQUMsR0FBVyxDQUFDLE1BQU0sQ0FBQyxPQUFjLENBQUMsQ0FBQztRQUMzRCxLQUFLLE1BQU0sQ0FBQyxDQUFDLE9BQVEsR0FBRyxDQUFDLElBQVksQ0FBQyxNQUFNLENBQUMsT0FBYyxDQUFDLENBQUM7UUFDN0QsS0FBSyxLQUFLLENBQUMsQ0FBQyxPQUFRLEdBQUcsQ0FBQyxHQUFXLENBQUMsTUFBTSxDQUFDLE9BQWMsQ0FBQyxDQUFDO1FBQzNELEtBQUssTUFBTSxDQUFDLENBQUMsT0FBUSxHQUFHLENBQUMsSUFBWSxDQUFDLE1BQU0sQ0FBQyxPQUFjLENBQUMsQ0FBQztRQUM3RCxLQUFLLE1BQU0sQ0FBQyxDQUFDLE9BQVEsR0FBRyxDQUFDLElBQVksQ0FBQyxNQUFNLENBQUMsT0FBYyxDQUFDLENBQUM7UUFDN0QsS0FBSyxNQUFNLENBQUMsQ0FBQyxPQUFRLEdBQUcsQ0FBQyxJQUFZLENB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QUksQ0FBQyxDQUFDO0lBQy9DLElBQUksQ0FBQyxVQUFVO1FBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQyw0QkFBNEIsS0FBSyxhQUFMLEtBQUssdUJBQUwsS0FBSyxDQUFFLElBQUksR0FBRyxDQUFDLENBQUM7SUFDN0UsT0FBTyxVQUFVLENBQUMsS0FBSyxFQUFFLFVBQVUsQ0FBQyxDQUFDO0FBQ3pDLENBQUM7QUFiRCxzQkFhQztBQUVZLFFBQUEsVUFBVSxHQUFHO0lBQ3RCLEdBQUcsRUFBRSxLQUFLO0lBQ1YsSUFBSSxFQUFFLE1BQU07SUFDWixHQUFHLEVBQUUsS0FBSztJQUNWLEdBQUcsRUFBRSxLQUFLO0lBQ1YsSUFBSSxFQUFFLE1BQU07SUFDWixJQUFJLEVBQUUsTUFBTTtJQUNaLElBQUksRUFBRSxNQUFNO0lBQ1osSUFBSSxFQUFFLE1BQU07SUFDWixJQUFJLEVBQUUsTUFBTTtJQUNaLEdBQUcsRUFBRSxLQUFLO0NBQ2IsQ0FBQztBQUVGLFNBQWdCLHdCQUF3QixDQUFDLElBQUk7SUFDekMsSUFBSSxDQUFDLElBQUk7UUFBRSxPQUFPLFNBQVMsQ0FBQztJQUM1QixPQUFPLGtCQUFVLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUMsSUFBSSxTQUFTLENBQUM7QUFDaEcsQ0FBQztBQUhELDREQUdDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgYXZhaWxhYmxlVGFyZ2V0VHlwZXMgZnJvbSBcIi4vdGFyZ2V0LXR5cGVzXCI7XG5pbXBvcnQgKiBhcyBhdmFpbGFibGVTb3VyY2VUeXBlcyBmcm9tIFwiLi9zb3VyY2UtdHlwZXNcIjtcbmltcG9ydCB7Zm9ybWF0fSBmcm9tIFwiLi90eXBlc1wiO1xuXG5leHBvcnQgZnVuY3Rpb24gcGFyc2VEc24oc3RyaW5nOiBzdHJpbmcpIHtcbiAgICBjb25zdCBbdHlwZSwgbG9jYXRpb24gPSB1bmRlZmluZWRdID0gc3RyaW5nLnNwbGl0KC86XFwvXFwvLyk7XG4gICAgcmV0dXJuIHt0eXBlOiBsb2NhdGlvbiA/IHR5cGUgOiAnZmlsZScsIGxvY2F0aW9uOiBsb2NhdGlvbiB8fCB0eXBlfTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGFwcGx5Rm9ybWF0KGltZzogYW55LCBmb3JtYXQ6IGZvcm1hdCkge1xuICAgIHN3aXRjaCAoZm9ybWF0Py50eXBlKSB7XG4gICAgICAgIGNhc2UgJ3BuZyc6IHJldHVybiAoaW1nLnBuZyBhcyBhbnkpKGZvcm1hdC5vcHRpb25zIGFzIGFueSk7XG4gICAgICAgIGNhc2UgJ2pwZWcnOiByZXR1cm4gKGltZy5qcGVnIGFzIGFueSkoZm9ybWF0Lm9wdGlvbnMgYXMgYW55KTtcbiAgICAgICAgY2FzZSAnZ2lmJzogcmV0dXJuIChpbWcuZ2lmIGFzIGFueSkoZm9ybWF0Lm9wdGlvbnMgYXMgYW55KTtcbiAgICAgICAgY2FzZSAnd2VicCc6IHJldHVybiAoaW1nLndlYnAgYXMgYW55KShmb3JtYXQub3B0aW9ucyBhcyBhbnkpO1xuICAgICAgICBjYXNlICd0aWZmJzogcmV0dXJuIChpbWcudGlmZiBhcyBhbnkpKGZvcm1hdC5vcHRpb25zIGFzIGFueSk7XG4gICAgICAgIGNhc2UgJ2F2aWYnOiByZXR1cm4gKGltZy5hdmlmIGFzIGFueSkoZm9ybWF0Lm9wdGlvbnMgYXMgYW55KTtcbiAgICAgICAgY2FzZSAnaGVpZic6IHJldHVybiAoaW1nLmhlaWYgYXMgYW55KShmb3JtYXQub3B0aW9ucyBhcyBhbnkpO1xuICAgICAgICBjYXNlICdyYXcnOiByZXR1cm4gKGltZy5yYXcgYXMgYW55KShmb3JtYXQub3B0aW9ucyBhcyBhbnkpO1xuICAgICAgICBkZWZhdWx0OiByZXR1cm4gaW1nO1xuICAgIH1cbn1cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBkZXNjcmliZVRhcmdldChvdXRwdXQsIGZvcm1hdDogYW55ID0gdW5kZWZpbmVkKSB7XG4gICAgaWYgKCFvdXRwdXQpIHRocm93IG5ldyBFcnJvcihgT3V0cHV0IGlzIGVtcHR5YCk7XG4gICAgaWYgKCdzdHJpbmcnID09PSB0eXBlb2Ygb3V0cHV0KSB7XG4gICAgICAgIHN3aXRjaCAob3V0cHV0KSB7XG4gICAgICAgICAgICBjYXNlICdzdGRvdXQnOiBvdXRwdXQgPSAnc3Rkb3V0Oi8vc3Rkb3V0JzsgYnJlYWs7XG4gICAgICAgICAgICBjYXNlICdidWZmZXInOiBvdXRwdXQgPSAnYnVmZmVyOi8vYnVmZmVyJzsgYnJlYWs7XG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgIGlmICgtMSA9PT0gb3V0cHV0LmluZGV4T2YoJzovLycpKSB7XG4gICAgICAgICAgICAgICAgICAgIG91dHB1dCA9IGBmaWxlOi8vJHtvdXRwdXR9YDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgICAgb3V0cHV0ID0gcGFyc2VEc24ob3V0cHV0KTtcbiAgICB9XG4gICAgY29uc3QgZGV0ZWN0ZWRGb3JtYXROYW1lID0gZGV0ZWN0Rm9ybWF0RnJvbUZpbGVOYW1lKG91dHB1dC5sb2NhdGlvbik7XG4gICAgcmV0dXJuIHtmb3JtYXQ6IGZvcm1hdCB8fCAoZGV0ZWN0ZWRGb3JtYXROYW1lID8ge3R5cGU6IGRldGVjdGVkRm9ybWF0TmFtZX0gOiBvdXRwdXQuZm9ybWF0KSwgdGFyZ2V0OiB7Li4ub3V0cHV0fX07XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBzYXZlKGltZywgdGFyZ2V0LCB0YXJnZXRUeXBlcyA9IHt9KSB7XG4gICAgY29uc3QgYWxsVGFyZ2V0VHlwZXMgPSB7Li4uYXZhaWxhYmxlVGFyZ2V0VHlwZXMsIC4uLnRhcmdldFR5cGVzfTtcbiAgICBjb25zdCB0YXJnZXRUeXBlID0gYWxsVGFyZ2V0VHlwZXNbdGFyZ2V0Py50eXBlXTtcbiAgICBpZiAoIXRhcmdldFR5cGUpIHRocm93IG5ldyBFcnJvcihgVW5zdXBwb3J0ZWQgdGFyZ2V0IHR5cGUgJyR7dGFyZ2V0Py50eXBlfSdgKTtcbiAgICByZXR1cm4gdGFyZ2V0VHlwZShpbWcsIHRhcmdldClcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGZldGNoKGlucHV0LCBzb3VyY2VUeXBlcyA9IHt9KSB7XG4gICAgaWYgKCFpbnB1dCkgdGhyb3cgbmV3IEVycm9yKGBJbnB1dCBpcyBlbXB0eWApO1xuICAgIGlmIChCdWZmZXIuaXNCdWZmZXIoaW5wdXQpKSByZXR1cm4gaW5wdXQ7XG4gICAgaWYgKCdzdHJpbmcnID09PSB0eXBlb2YgaW5wdXQpIHtcbiAgICAgICAgaWYgKC0xID09PSBpbnB1dC5pbmRleE9mKCc6Ly8nKSkge1xuICAgICAgICAgICAgaW5wdXQgPSBgZmlsZTovLyR7aW5wdXR9YDtcbiAgICAgICAgfVxuICAgICAgICBpbnB1dCA9IHBhcnNlRHNuKGlucHV0KTtcbiAgICB9XG4gICAgY29uc3QgYWxsU291cmNlVHlwZXMgPSB7Li4uYXZhaWxhYmxlU291cmNlVHlwZXMsIC4uLnNvdXJjZVR5cGVzfTtcbiAgICBjb25zdCBzb3VyY2VUeXBlID0gYWxsU291cmNlVHlwZXNbaW5wdXQ/LnR5cGVdO1xuICAgIGlmICghc291cmNlVHlwZSkgdGhyb3cgbmV3IEVycm9yKGBVbnN1cHBvcnRlZCBzb3VyY2UgdHlwZSAnJHtpbnB1dD8udHlwZX0nYCk7XG4gICAgcmV0dXJuIHNvdXJjZVR5cGUoaW5wdXQsIHNvdXJjZVR5cGUpO1xufVxuXG5leHBvcnQgY29uc3QgZXh0ZW5zaW9ucyA9IHtcbiAgICBqcGc6ICdqcGcnLFxuICAgIGpwZWc6ICdqcGVnJyxcbiAgICBwbmc6ICdwbmcnLFxuICAgIGdpZjogJ2dpZicsXG4gICAgd2VicDogJ3dlYnAnLFxuICAgIHRpZmY6ICd0aWZmJyxcbiAgICBhdmlmOiAnYXZpZicsXG4gICAgaGVpYzogJ2hlaWYnLFxuICAgIGhlaWY6ICdoZWlmJyxcbiAgICByYXc6ICdyYXcnLFxufTtcblxuZXhwb3J0IGZ1bmN0aW9uIGRldGVjdEZvcm1hdEZyb21GaWxlTmFtZShuYW1lKTogc3RyaW5nfHVuZGVmaW5lZCB7XG4gICAgaWYgKCFuYW1lKSByZXR1cm4gdW5kZWZpbmVkO1xuICAgIHJldHVybiBleHRlbnNpb25zWyhuYW1lLnNsaWNlKG5hbWUubGFzdEluZGV4T2YoJy4nKSArIDEpIHx8ICcnKS50b0xvd2VyQ2FzZSgpXSB8fCB1bmRlZmluZWQ7XG59XG4iXX0=