"use strict";
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];
    result["default"] = mod;
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
const availableTargetTypes = __importStar(require("./target-types"));
const availableSourceTypes = __importStar(require("./source-types"));
function parseDsn(string) {
    const [type, location = undefined] = string.split(/:\/\//);
    return { type: location ? type : 'file', location: location || type };
}
exports.parseDsn = parseDsn;
async function applyFormat(img, format) {
    switch (format === null || format === void 0 ? void 0 : format.type) {
        case 'png': return img.png(format.options);
        case 'jpeg': return img.jpeg(format.options);
        case 'gif': return img.gif(format.options);
        case 'webp': return img.webp(format.options);
        case 'tiff': return img.tiff(format.options);
        case 'avif': return img.avif(format.options);
        case 'heif': return img.heif(format.options);
        case 'raw': return img.raw(format.options);
        default: return img;
    }
}
exports.applyFormat = applyFormat;
async function describeTarget(output, format = undefined) {
    if (!output)
        throw new Error(`Output is empty`);
    if ('string' === typeof output) {
        switch (output) {
            case 'stdout':
                output = 'stdout://stdout';
                break;
            case 'buffer':
                output = 'buffer://buffer';
                break;
            default:
                if (-1 === output.indexOf('://')) {
                    output = `file://${output}`;
                }
                break;
        }
        output = parseDsn(output);
    }
    const detectedFormatName = detectFormatFromFileName(output.location);
    return { format: format ? ('string' === typeof format ? { type: format } : format) : (detectedFormatName ? { type: detectedFormatName } : output.format), target: { ...output } };
}
exports.describeTarget = describeTarget;
async function save(img, target, targetTypes = {}) {
    const allTargetTypes = { ...availableTargetTypes, ...targetTypes };
    const targetType = allTargetTypes[target === null || target === void 0 ? void 0 : target.type];
    if (!targetType)
        throw new Error(`Unsupported target type '${target === null || target === void 0 ? void 0 : target.type}'`);
    return targetType(img, target);
}
exports.save = save;
async function fetch(input, sourceTypes = {}) {
    if (!input)
        throw new Error(`Input is empty`);
    if (Buffer.isBuffer(input))
        return input;
    if ('string' === typeof input) {
        if (-1 === input.indexOf('://')) {
            input = `file://${input}`;
        }
        input = parseDsn(input);
    }
    const allSourceTypes = { ...availableSourceTypes, ...sourceTypes };
    const sourceType = allSourceTypes[input === null || input === void 0 ? void 0 : input.type];
    if (!sourceType)
        throw new Error(`Unsupported source type '${input === null || input === void 0 ? void 0 : input.type}'`);
    return sourceType(input, sourceType);
}
exports.fetch = fetch;
exports.extensions = {
    jpg: 'jpg',
    jpeg: 'jpeg',
    png: 'png',
    gif: 'gif',
    webp: 'webp',
    tiff: 'tiff',
    avif: 'avif',
    heic: 'heif',
    heif: 'heif',
    raw: 'raw',
};
function detectFormatFromFileName(name) {
    if (!name)
        return undefined;
    return exports.extensions[(name.slice(name.lastIndexOf('.') + 1) || '').toLowerCase()] || undefined;
}
exports.detectFormatFromFileName = detectFormatFromFileName;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvdXRpbHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUEscUVBQXVEO0FBQ3ZELHFFQUF1RDtBQUd2RCxTQUFnQixRQUFRLENBQUMsTUFBYztJQUNuQyxNQUFNLENBQUMsSUFBSSxFQUFFLFFBQVEsR0FBRyxTQUFTLENBQUMsR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQzNELE9BQU8sRUFBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLE1BQU0sRUFBRSxRQUFRLEVBQUUsUUFBUSxJQUFJLElBQUksRUFBQyxDQUFDO0FBQ3hFLENBQUM7QUFIRCw0QkFHQztBQUVNLEtBQUssVUFBVSxXQUFXLENBQUMsR0FBUSxFQUFFLE1BQWM7SUFDdEQsUUFBUSxNQUFNLGFBQU4sTUFBTSx1QkFBTixNQUFNLENBQUUsSUFBSSxFQUFFO1FBQ2xCLEtBQUssS0FBSyxDQUFDLENBQUMsT0FBUSxHQUFHLENBQUMsR0FBVyxDQUFDLE1BQU0sQ0FBQyxPQUFjLENBQUMsQ0FBQztRQUMzRCxLQUFLLE1BQU0sQ0FBQyxDQUFDLE9BQVEsR0FBRyxDQUFDLElBQVksQ0FBQyxNQUFNLENBQUMsT0FBYyxDQUFDLENBQUM7UUFDN0QsS0FBSyxLQUFLLENBQUMsQ0FBQyxPQUFRLEdBQUcsQ0FBQyxHQUFXLENBQUMsTUFBTSxDQUFDLE9BQWMsQ0FBQyxDQUFDO1FBQzNELEtBQUssTUFBTSxDQUFDLENBQUMsT0FBUSxHQUFHLENBQUMsSUFBWSxDQUFDLE1BQU0sQ0FBQyxPQUFjLENBQUMsQ0FBQztRQUM3RCxLQUFLLE1BQU0sQ0FBQyxDQUFDLE9BQVEsR0FBRyxDQUFDLElBQVksQ0FBQyxNQUFNLENBQUMsT0FBYyxDQUFDLENBQUM7UUFDN0QsS0FBSyxNQUFNLENBQUMsQ0FBQyxPQUFRLEdBQUcsQ0FBQyxJQUFZLENB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QUFjLEdBQUcsRUFBQyxHQUFHLG9CQUFvQixFQUFFLEdBQUcsV0FBVyxFQUFDLENBQUM7SUFDakUsTUFBTSxVQUFVLEdBQUcsY0FBYyxDQUFDLEtBQUssYUFBTCxLQUFLLHVCQUFMLEtBQUssQ0FBRSxJQUFJLENBQUMsQ0FBQztJQUMvQyxJQUFJLENBQUMsVUFBVTtRQUFFLE1BQU0sSUFBSSxLQUFLLENBQUMsNEJBQTRCLEtBQUssYUFBTCxLQUFLLHVCQUFMLEtBQUssQ0FBRSxJQUFJLEdBQUcsQ0FBQyxDQUFDO0lBQzdFLE9BQU8sVUFBVSxDQUFDLEtBQUssRUFBRSxVQUFVLENBQUMsQ0FBQztBQUN6QyxDQUFDO0FBYkQsc0JBYUM7QUFFWSxRQUFBLFVBQVUsR0FBRztJQUN0QixHQUFHLEVBQUUsS0FBSztJQUNWLElBQUksRUFBRSxNQUFNO0lBQ1osR0FBRyxFQUFFLEtBQUs7SUFDVixHQUFHLEVBQUUsS0FBSztJQUNWLElBQUksRUFBRSxNQUFNO0lBQ1osSUFBSSxFQUFFLE1BQU07SUFDWixJQUFJLEVBQUUsTUFBTTtJQUNaLElBQUksRUFBRSxNQUFNO0lBQ1osSUFBSSxFQUFFLE1BQU07SUFDWixHQUFHLEVBQUUsS0FBSztDQUNiLENBQUM7QUFFRixTQUFnQix3QkFBd0IsQ0FBQyxJQUFJO0lBQ3pDLElBQUksQ0FBQyxJQUFJO1FBQUUsT0FBTyxTQUFTLENBQUM7SUFDNUIsT0FBTyxrQkFBVSxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDLElBQUksU0FBUyxDQUFDO0FBQ2hHLENBQUM7QUFIRCw0REFHQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGF2YWlsYWJsZVRhcmdldFR5cGVzIGZyb20gXCIuL3RhcmdldC10eXBlc1wiO1xuaW1wb3J0ICogYXMgYXZhaWxhYmxlU291cmNlVHlwZXMgZnJvbSBcIi4vc291cmNlLXR5cGVzXCI7XG5pbXBvcnQge2Zvcm1hdH0gZnJvbSBcIi4vdHlwZXNcIjtcblxuZXhwb3J0IGZ1bmN0aW9uIHBhcnNlRHNuKHN0cmluZzogc3RyaW5nKSB7XG4gICAgY29uc3QgW3R5cGUsIGxvY2F0aW9uID0gdW5kZWZpbmVkXSA9IHN0cmluZy5zcGxpdCgvOlxcL1xcLy8pO1xuICAgIHJldHVybiB7dHlwZTogbG9jYXRpb24gPyB0eXBlIDogJ2ZpbGUnLCBsb2NhdGlvbjogbG9jYXRpb24gfHwgdHlwZX07XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBhcHBseUZvcm1hdChpbWc6IGFueSwgZm9ybWF0OiBmb3JtYXQpIHtcbiAgICBzd2l0Y2ggKGZvcm1hdD8udHlwZSkge1xuICAgICAgICBjYXNlICdwbmcnOiByZXR1cm4gKGltZy5wbmcgYXMgYW55KShmb3JtYXQub3B0aW9ucyBhcyBhbnkpO1xuICAgICAgICBjYXNlICdqcGVnJzogcmV0dXJuIChpbWcuanBlZyBhcyBhbnkpKGZvcm1hdC5vcHRpb25zIGFzIGFueSk7XG4gICAgICAgIGNhc2UgJ2dpZic6IHJldHVybiAoaW1nLmdpZiBhcyBhbnkpKGZvcm1hdC5vcHRpb25zIGFzIGFueSk7XG4gICAgICAgIGNhc2UgJ3dlYnAnOiByZXR1cm4gKGltZy53ZWJwIGFzIGFueSkoZm9ybWF0Lm9wdGlvbnMgYXMgYW55KTtcbiAgICAgICAgY2FzZSAndGlmZic6IHJldHVybiAoaW1nLnRpZmYgYXMgYW55KShmb3JtYXQub3B0aW9ucyBhcyBhbnkpO1xuICAgICAgICBjYXNlICdhdmlmJzogcmV0dXJuIChpbWcuYXZpZiBhcyBhbnkpKGZvcm1hdC5vcHRpb25zIGFzIGFueSk7XG4gICAgICAgIGNhc2UgJ2hlaWYnOiByZXR1cm4gKGltZy5oZWlmIGFzIGFueSkoZm9ybWF0Lm9wdGlvbnMgYXMgYW55KTtcbiAgICAgICAgY2FzZSAncmF3JzogcmV0dXJuIChpbWcucmF3IGFzIGFueSkoZm9ybWF0Lm9wdGlvbnMgYXMgYW55KTtcbiAgICAgICAgZGVmYXVsdDogcmV0dXJuIGltZztcbiAgICB9XG59XG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZGVzY3JpYmVUYXJnZXQob3V0cHV0LCBmb3JtYXQ6IGFueSA9IHVuZGVmaW5lZCkge1xuICAgIGlmICghb3V0cHV0KSB0aHJvdyBuZXcgRXJyb3IoYE91dHB1dCBpcyBlbXB0eWApO1xuICAgIGlmICgnc3RyaW5nJyA9PT0gdHlwZW9mIG91dHB1dCkge1xuICAgICAgICBzd2l0Y2ggKG91dHB1dCkge1xuICAgICAgICAgICAgY2FzZSAnc3Rkb3V0Jzogb3V0cHV0ID0gJ3N0ZG91dDovL3N0ZG91dCc7IGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAnYnVmZmVyJzogb3V0cHV0ID0gJ2J1ZmZlcjovL2J1ZmZlcic7IGJyZWFrO1xuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICBpZiAoLTEgPT09IG91dHB1dC5pbmRleE9mKCc6Ly8nKSkge1xuICAgICAgICAgICAgICAgICAgICBvdXRwdXQgPSBgZmlsZTovLyR7b3V0cHV0fWA7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICAgIG91dHB1dCA9IHBhcnNlRHNuKG91dHB1dCk7XG4gICAgfVxuICAgIGNvbnN0IGRldGVjdGVkRm9ybWF0TmFtZSA9IGRldGVjdEZvcm1hdEZyb21GaWxlTmFtZShvdXRwdXQubG9jYXRpb24pO1xuICAgIHJldHVybiB7Zm9ybWF0OiBmb3JtYXQgPyAoJ3N0cmluZycgPT09IHR5cGVvZiBmb3JtYXQgPyB7dHlwZTogZm9ybWF0fSA6IGZvcm1hdCkgOiAoZGV0ZWN0ZWRGb3JtYXROYW1lID8ge3R5cGU6IGRldGVjdGVkRm9ybWF0TmFtZX0gOiBvdXRwdXQuZm9ybWF0KSwgdGFyZ2V0OiB7Li4ub3V0cHV0fX07XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBzYXZlKGltZywgdGFyZ2V0LCB0YXJnZXRUeXBlcyA9IHt9KSB7XG4gICAgY29uc3QgYWxsVGFyZ2V0VHlwZXMgPSB7Li4uYXZhaWxhYmxlVGFyZ2V0VHlwZXMsIC4uLnRhcmdldFR5cGVzfTtcbiAgICBjb25zdCB0YXJnZXRUeXBlID0gYWxsVGFyZ2V0VHlwZXNbdGFyZ2V0Py50eXBlXTtcbiAgICBpZiAoIXRhcmdldFR5cGUpIHRocm93IG5ldyBFcnJvcihgVW5zdXBwb3J0ZWQgdGFyZ2V0IHR5cGUgJyR7dGFyZ2V0Py50eXBlfSdgKTtcbiAgICByZXR1cm4gdGFyZ2V0VHlwZShpbWcsIHRhcmdldClcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGZldGNoKGlucHV0LCBzb3VyY2VUeXBlcyA9IHt9KSB7XG4gICAgaWYgKCFpbnB1dCkgdGhyb3cgbmV3IEVycm9yKGBJbnB1dCBpcyBlbXB0eWApO1xuICAgIGlmIChCdWZmZXIuaXNCdWZmZXIoaW5wdXQpKSByZXR1cm4gaW5wdXQ7XG4gICAgaWYgKCdzdHJpbmcnID09PSB0eXBlb2YgaW5wdXQpIHtcbiAgICAgICAgaWYgKC0xID09PSBpbnB1dC5pbmRleE9mKCc6Ly8nKSkge1xuICAgICAgICAgICAgaW5wdXQgPSBgZmlsZTovLyR7aW5wdXR9YDtcbiAgICAgICAgfVxuICAgICAgICBpbnB1dCA9IHBhcnNlRHNuKGlucHV0KTtcbiAgICB9XG4gICAgY29uc3QgYWxsU291cmNlVHlwZXMgPSB7Li4uYXZhaWxhYmxlU291cmNlVHlwZXMsIC4uLnNvdXJjZVR5cGVzfTtcbiAgICBjb25zdCBzb3VyY2VUeXBlID0gYWxsU291cmNlVHlwZXNbaW5wdXQ/LnR5cGVdO1xuICAgIGlmICghc291cmNlVHlwZSkgdGhyb3cgbmV3IEVycm9yKGBVbnN1cHBvcnRlZCBzb3VyY2UgdHlwZSAnJHtpbnB1dD8udHlwZX0nYCk7XG4gICAgcmV0dXJuIHNvdXJjZVR5cGUoaW5wdXQsIHNvdXJjZVR5cGUpO1xufVxuXG5leHBvcnQgY29uc3QgZXh0ZW5zaW9ucyA9IHtcbiAgICBqcGc6ICdqcGcnLFxuICAgIGpwZWc6ICdqcGVnJyxcbiAgICBwbmc6ICdwbmcnLFxuICAgIGdpZjogJ2dpZicsXG4gICAgd2VicDogJ3dlYnAnLFxuICAgIHRpZmY6ICd0aWZmJyxcbiAgICBhdmlmOiAnYXZpZicsXG4gICAgaGVpYzogJ2hlaWYnLFxuICAgIGhlaWY6ICdoZWlmJyxcbiAgICByYXc6ICdyYXcnLFxufTtcblxuZXhwb3J0IGZ1bmN0aW9uIGRldGVjdEZvcm1hdEZyb21GaWxlTmFtZShuYW1lKTogc3RyaW5nfHVuZGVmaW5lZCB7XG4gICAgaWYgKCFuYW1lKSByZXR1cm4gdW5kZWZpbmVkO1xuICAgIHJldHVybiBleHRlbnNpb25zWyhuYW1lLnNsaWNlKG5hbWUubGFzdEluZGV4T2YoJy4nKSArIDEpIHx8ICcnKS50b0xvd2VyQ2FzZSgpXSB8fCB1bmRlZmluZWQ7XG59XG4iXX0=