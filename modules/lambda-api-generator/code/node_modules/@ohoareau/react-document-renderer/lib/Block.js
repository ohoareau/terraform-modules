"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];
    result["default"] = mod;
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
const react_1 = __importDefault(require("react"));
const renderer_1 = require("@react-pdf/renderer");
const hocs_1 = require("./hocs");
const coreBlocks = __importStar(require("./blocks"));
const ContextContext_1 = require("./contexts/ContextContext");
const buildingBlocks = __importStar(require("./plugins/building/blocks"));
const blocks = { core: coreBlocks, building: buildingBlocks };
const SelectionWrapper = hocs_1.pdfComponent({
    selection_wrapper: {
        backgroundColor: '#3f51b5',
        color: 'white',
    },
}, ({ s = () => { }, children }) => (react_1.default.createElement(renderer_1.View, { style: s('selection_wrapper') }, children)));
const renderBlock = (key, block, Component, props, cfg, context, test, suggestions) => {
    if (block.hiddable && !cfg.visible)
        return null;
    if (block.condition && !test(block.condition))
        return null;
    let c = react_1.default.createElement(Component, Object.assign({ key: key, block: block }, props));
    if (block.enrichable && cfg.enrichment)
        c = (react_1.default.createElement(react_1.default.Fragment, null,
            c,
            cfg.enrichment.map((en, i) => react_1.default.createElement(Block, { key: i, id: `${block.id}_enrichment_${i}`, block: { type: en.type, text: en.children.map(x => x.text).join("\n") } }))));
    if (block.suggestions && cfg.suggestions)
        c = (react_1.default.createElement(react_1.default.Fragment, null,
            c,
            Object.entries(cfg.suggestions).map(([k, v], i) => suggestions[k] ? react_1.default.createElement(Block, { key: i, id: `${block.id}_suggestion_${k}`, block: suggestions[k] }) : null)));
    context && (c = react_1.default.createElement(ContextContext_1.ContextProvider, { key: key, value: context || {} }, c));
    if (cfg.selected)
        c = react_1.default.createElement(SelectionWrapper, { key: key }, c);
    if (block.pagebreak)
        c = react_1.default.createElement(renderer_1.Text, { key: key, wrap: true, break: true }, c);
    return c;
};
const Block = hocs_1.pdfComponent(undefined, ({ id, block, cfg = {}, v = () => { }, suggestions = {}, test = () => { }, model, ...props }) => {
    const tokens = (block.type || '').split(':');
    let items, key;
    switch (tokens.length) {
        case 0:
            items = blocks.core;
            key = 'unknown';
            break;
        case 1:
            items = blocks.core;
            key = block.type;
            break;
        default:
            items = ('@' === tokens[0].charAt(0))
                ? require(`./plugins/${tokens[0].slice(1)}/blocks`)
                : require(`${tokens[0]}/blocks`);
            key = tokens[1];
            break;
    }
    const Component = (items || {})[key] || blocks.core.unknown;
    if (block.foreach) {
        return (react_1.default.createElement(react_1.default.Fragment, null, (v(block.foreach) || []).map((context, i) => renderBlock(i, block, Component, props, cfg, context, test, suggestions))));
    }
    return renderBlock(undefined, block, Component, props, cfg, undefined, test, suggestions);
});
exports.default = Block;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQmxvY2suanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvQmxvY2sudHN4Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztBQUFBLGtEQUEwQjtBQUMxQixrREFBK0M7QUFDL0MsaUNBQW9DO0FBQ3BDLHFEQUF1QztBQUN2Qyw4REFBMEQ7QUFDMUQsMEVBQTREO0FBRTVELE1BQU0sTUFBTSxHQUFHLEVBQUMsSUFBSSxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsY0FBYyxFQUFDLENBQUM7QUFFNUQsTUFBTSxnQkFBZ0IsR0FBRyxtQkFBWSxDQUFDO0lBQ2xDLGlCQUFpQixFQUFFO1FBQ2YsZUFBZSxFQUFFLFNBQVM7UUFDMUIsS0FBSyxFQUFFLE9BQU87S0FDakI7Q0FDSixFQUFFLENBQUMsRUFBQyxDQUFDLEdBQUcsR0FBRyxFQUFFLEdBQUUsQ0FBQyxFQUFFLFFBQVEsRUFBQyxFQUFFLEVBQUUsQ0FBQyxDQUM3Qiw4QkFBQyxlQUFJLElBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxtQkFBbUIsQ0FBQyxJQUM5QixRQUFRLENBQ04sQ0FDVixDQUFDLENBQUM7QUFFSCxNQUFNLFdBQVcsR0FBRyxDQUFDLEdBQUcsRUFBRSxLQUFLLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxXQUFXLEVBQUUsRUFBRTtJQUNsRixJQUFJLEtBQUssQ0FBQyxRQUFRLElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTztRQUFFLE9BQU8sSUFBSSxDQUFDO0lBQ2hELElBQUksS0FBSyxDQUFDLFNBQVMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDO1FBQUUsT0FBTyxJQUFJLENBQUM7SUFDM0QsSUFBSSxDQUFDLEdBQUcsOEJBQUMsU0FBUyxrQkFBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxLQUFLLElBQU0sS0FBSyxFQUFJLENBQUM7SUFDekQsSUFBSSxLQUFL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LENBQUMsYUFBYSxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUM7Z0JBQ25ELENBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRyxNQUFNLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUNuQztZQUFDLEdBQUcsR0FBRyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFBQyxNQUFNO0tBQ2hDO0lBQ0QsTUFBTSxTQUFTLEdBQUcsQ0FBQyxLQUFLLElBQUksRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUM7SUFDNUQsSUFBSSxLQUFLLENBQUMsT0FBTyxFQUFFO1FBQ2YsT0FBTyxDQUNILDhEQUNNLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLENBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxXQUFXLENBQUMsQ0FBQyxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLFdBQVcsQ0FBQyxDQUFDLENBQ25JLENBQ04sQ0FBQztLQUNMO0lBQ0QsT0FBTyxXQUFXLENBQUMsU0FBUyxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLFdBQVcsQ0FBQyxDQUFDO0FBQzlGLENBQUMsQ0FBQyxDQUFDO0FBZUgsa0JBQWUsS0FBSyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFJlYWN0IGZyb20gJ3JlYWN0JztcbmltcG9ydCB7VGV4dCwgVmlld30gZnJvbSAnQHJlYWN0LXBkZi9yZW5kZXJlcic7XG5pbXBvcnQge3BkZkNvbXBvbmVudH0gZnJvbSAnLi9ob2NzJztcbmltcG9ydCAqIGFzIGNvcmVCbG9ja3MgZnJvbSAnLi9ibG9ja3MnO1xuaW1wb3J0IHtDb250ZXh0UHJvdmlkZXJ9IGZyb20gJy4vY29udGV4dHMvQ29udGV4dENvbnRleHQnO1xuaW1wb3J0ICogYXMgYnVpbGRpbmdCbG9ja3MgZnJvbSAnLi9wbHVnaW5zL2J1aWxkaW5nL2Jsb2Nrcyc7XG5cbmNvbnN0IGJsb2NrcyA9IHtjb3JlOiBjb3JlQmxvY2tzLCBidWlsZGluZzogYnVpbGRpbmdCbG9ja3N9O1xuXG5jb25zdCBTZWxlY3Rpb25XcmFwcGVyID0gcGRmQ29tcG9uZW50KHtcbiAgICBzZWxlY3Rpb25fd3JhcHBlcjoge1xuICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6ICcjM2Y1MWI1JyxcbiAgICAgICAgY29sb3I6ICd3aGl0ZScsXG4gICAgfSxcbn0sICh7cyA9ICgpID0+IHt9LCBjaGlsZHJlbn0pID0+IChcbiAgICA8VmlldyBzdHlsZT17cygnc2VsZWN0aW9uX3dyYXBwZXInKX0+XG4gICAgICAgIHtjaGlsZHJlbn1cbiAgICA8L1ZpZXc+XG4pKTtcblxuY29uc3QgcmVuZGVyQmxvY2sgPSAoa2V5LCBibG9jaywgQ29tcG9uZW50LCBwcm9wcywgY2ZnLCBjb250ZXh0LCB0ZXN0LCBzdWdnZXN0aW9ucykgPT4ge1xuICAgIGlmIChibG9jay5oaWRkYWJsZSAmJiAhY2ZnLnZpc2libGUpIHJldHVybiBudWxsO1xuICAgIGlmIChibG9jay5jb25kaXRpb24gJiYgIXRlc3QoYmxvY2suY29uZGl0aW9uKSkgcmV0dXJuIG51bGw7XG4gICAgbGV0IGMgPSA8Q29tcG9uZW50IGtleT17a2V5fSBibG9jaz17YmxvY2t9IHsuLi5wcm9wc30gLz47XG4gICAgaWYgKGJsb2NrLmVucmljaGFibGUgJiYgY2ZnLmVucmljaG1lbnQpIGMgPSAoXG4gICAgICAgIDw+XG4gICAgICAgICAgICB7Y31cbiAgICAgICAgICAgIHtjZmcuZW5yaWNobWVudC5tYXAoKGVuLCBpKSA9PiA8QmxvY2sga2V5PXtpfSBpZD17YCR7YmxvY2suaWR9X2VucmljaG1lbnRfJHtpfWB9IGJsb2NrPXt7dHlwZTogZW4udHlwZSwgdGV4dDogZW4uY2hpbGRyZW4ubWFwKHggPT4geC50ZXh0KS5qb2luKFwiXFxuXCIpfX0gLz4pfVxuICAgICAgICA8Lz5cbiAgICApO1xuICAgIGlmIChibG9jay5zdWdnZXN0aW9ucyAmJiBjZmcuc3VnZ2VzdGlvbnMpIGMgPSAoXG4gICAgICAgIDw+XG4gICAgICAgICAgICB7Y31cbiAgICAgICAgICAgIHtPYmplY3QuZW50cmllcyhjZmcuc3VnZ2VzdGlvbnMpLm1hcCgoW2ssIHZdLCBpKSA9PiBzdWdnZXN0aW9uc1trXSA/IDxCbG9jayBrZXk9e2l9IGlkPXtgJHtibG9jay5pZH1fc3VnZ2VzdGlvbl8ke2t9YH0gYmxvY2s9e3N1Z2dlc3Rpb25zW2tdfSAvPiA6IG51bGwpfVxuICAgICAgICA8Lz5cbiAgICApO1xuICAgIGNvbnRleHQgJiYgKGMgPSA8Q29udGV4dFByb3ZpZGVyIGtleT17a2V5fSB2YWx1ZT17Y29udGV4dCB8fCB7fX0+e2N9PC9Db250ZXh0UHJvdmlkZXI+KTtcbiAgICBpZiAoY2ZnLnNlbGVjdGVkKSBjID0gPFNlbGVjdGlvbldyYXBwZXIga2V5PXtrZXl9PntjfTwvU2VsZWN0aW9uV3JhcHBlcj47XG4gICAgaWYgKGJsb2NrLnBhZ2VicmVhaykgYyA9IDxUZXh0IGtleT17a2V5fSB3cmFwIGJyZWFrPntjfTwvVGV4dD47XG4gICAgcmV0dXJuIGM7XG59XG5cbmNvbnN0IEJsb2NrID0gcGRmQ29tcG9uZW50PEJsb2NrUHJvcHM+KHVuZGVmaW5lZCwgKHtpZCwgYmxvY2ssIGNmZyA9IHt9LCB2ID0gKCkgPT4ge30sIHN1Z2dlc3Rpb25zID0ge30sIHRlc3QgPSAoKSA9PiB7fSwgbW9kZWwsIC4uLnByb3BzfTogQmxvY2tQcm9wcykgPT4ge1xuICAgIGNvbnN0IHRva2VucyA9IChibG9jay50eXBlIHx8ICcnKS5zcGxpdCgnOicpO1xuICAgIGxldCBpdGVtcywga2V5O1xuICAgIHN3aXRjaCAodG9rZW5zLmxlbmd0aCkge1xuICAgICAgICBjYXNlIDA6IGl0ZW1zID0gYmxvY2tzLmNvcmU7IGtleSA9ICd1bmtub3duJzsgYnJlYWs7XG4gICAgICAgIGNhc2UgMTogaXRlbXMgPSBibG9ja3MuY29yZTsga2V5ID0gYmxvY2sudHlwZTsgYnJlYWs7XG4gICAgICAgIGRlZmF1bHQ6IGl0ZW1zID0gKCdAJyA9PT0gdG9rZW5zWzBdLmNoYXJBdCgwKSlcbiAgICAgICAgICAgICAgICA/IHJlcXVpcmUoYC4vcGx1Z2lucy8ke3Rva2Vuc1swXS5zbGljZSgxKX0vYmxvY2tzYClcbiAgICAgICAgICAgICAgICA6IHJlcXVpcmUoYCR7dG9rZW5zWzBdfS9ibG9ja3NgKVxuICAgICAgICAgICAgOyBrZXkgPSB0b2tlbnNbMV07IGJyZWFrO1xuICAgIH1cbiAgICBjb25zdCBDb21wb25lbnQgPSAoaXRlbXMgfHwge30pW2tleV0gfHwgYmxvY2tzLmNvcmUudW5rbm93bjtcbiAgICBpZiAoYmxvY2suZm9yZWFjaCkge1xuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgPD5cbiAgICAgICAgICAgICAgICB7KCh2KGJsb2NrLmZvcmVhY2gpIHx8IFtdKSBhcyBhbnlbXSkubWFwKChjb250ZXh0LCBpKSA9PiByZW5kZXJCbG9jayhpLCBibG9jaywgQ29tcG9uZW50LCBwcm9wcywgY2ZnLCBjb250ZXh0LCB0ZXN0LCBzdWdnZXN0aW9ucykpfVxuICAgICAgICAgICAgPC8+XG4gICAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiByZW5kZXJCbG9jayh1bmRlZmluZWQsIGJsb2NrLCBDb21wb25lbnQsIHByb3BzLCBjZmcsIHVuZGVmaW5lZCwgdGVzdCwgc3VnZ2VzdGlvbnMpO1xufSk7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQmxvY2tQcm9wcyB7XG4gICAgaWQ6IHN0cmluZyxcbiAgICBjZmc/OiBhbnksXG4gICAgdj86IEZ1bmN0aW9uLFxuICAgIHRlc3Q/OiBGdW5jdGlvbixcbiAgICBtb2RlbD86IGFueSxcbiAgICBzdWdnZXN0aW9ucz86IGFueSxcbiAgICBibG9jazoge1xuICAgICAgICB0eXBlOiBzdHJpbmcsXG4gICAgICAgIFtrZXk6IHN0cmluZ106IGFueSxcbiAgICB9LFxufVxuXG5leHBvcnQgZGVmYXVsdCBCbG9jayJdfQ==