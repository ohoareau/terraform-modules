"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const aws_1 = require("@ohoareau/aws");
async function dynamodb(ctx) {
    let { table = process.env.REDIRECT_DYNAMODB_TABLE, index = process.env.REDIRECT_DYNAMODB_INDEX, key = process.env.REDIRECT_DYNAMODB_KEY } = ctx.query;
    const tablePrefix = process.env[`DYNAMODB_${table.toUpperCase()}_TABLE_PREFIX`] || process.env.DYNAMODB_TABLE_PREFIX || undefined;
    table = tablePrefix ? `${tablePrefix}${table}` : table;
    try {
        const page = await aws_1.dynamodb.queryIndex(table, { [key]: ctx.query.file }, index);
        if (!page || !page.items || !page.items.length)
            return undefined;
        const data = page.items[0];
        if (!data || !data.location)
            return undefined;
        return { ...data };
    }
    catch (e) {
        console.error(e);
        return undefined;
    }
}
exports.dynamodb = dynamodb;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHluYW1vZGIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvc291cmNlcy9keW5hbW9kYi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLHVDQUFzRDtBQUUvQyxLQUFLLFVBQVUsUUFBUSxDQUFDLEdBQVE7SUFDbkMsSUFBSSxFQUFDLEtBQUssR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLHVCQUF1QixFQUFFLEtBQUssR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLHVCQUF1QixFQUFFLEdBQUcsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLHFCQUFxQixFQUFDLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQztJQUNwSixNQUFNLFdBQVcsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFlBQVksS0FBSyxDQUFDLFdBQVcsRUFBRSxlQUFlLENBQUMsSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLHFCQUFxQixJQUFJLFNBQVMsQ0FBQztJQUNsSSxLQUFLLEdBQUcsV0FBVyxDQUFDLENBQUMsQ0FBQyxHQUFHLFdBQVcsR0FBRyxLQUFLLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDO0lBQ3ZELElBQUk7UUFDQSxNQUFNLElBQUksR0FBRyxNQUFNLGNBQVcsQ0FBQyxVQUFVLENBQUMsS0FBSyxFQUFFLEVBQUMsQ0FBQyxHQUFHLENBQUMsRUFBRSxHQUFHLENBQUMsS0FBSyxDQUFDLElBQUksRUFBQyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ2pGLElBQUksQ0FBQyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNO1lBQUUsT0FBTyxTQUFTLENBQUM7UUFDakUsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUMzQixJQUFJLENBQUMsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVE7WUFBRSxPQUFPLFNBQVMsQ0FBQztRQUM5QyxPQUFPLEVBQUMsR0FBRyxJQUFJLEVBQUMsQ0FBQztLQUNwQjtJQUFDLE9BQU8sQ0FBQyxFQUFFO1FBQ1IsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNqQixPQUFPLFNBQVMsQ0FBQztLQUNwQjtBQUNMLENBQUM7QUFkRCw0QkFjQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7Y3R4fSBmcm9tICdAb2hvYXJlYXUvbGFtYmRhLXV0aWxzJztcbmltcG9ydCB7ZHluYW1vZGIgYXMgYXdzZHluYW1vZGJ9IGZyb20gJ0BvaG9hcmVhdS9hd3MnO1xuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZHluYW1vZGIoY3R4OiBjdHgpIHtcbiAgICBsZXQge3RhYmxlID0gcHJvY2Vzcy5lbnYuUkVESVJFQ1RfRFlOQU1PREJfVEFCTEUsIGluZGV4ID0gcHJvY2Vzcy5lbnYuUkVESVJFQ1RfRFlOQU1PREJfSU5ERVgsIGtleSA9IHByb2Nlc3MuZW52LlJFRElSRUNUX0RZTkFNT0RCX0tFWX0gPSBjdHgucXVlcnk7XG4gICAgY29uc3QgdGFibGVQcmVmaXggPSBwcm9jZXNzLmVudltgRFlOQU1PREJfJHt0YWJsZS50b1VwcGVyQ2FzZSgpfV9UQUJMRV9QUkVGSVhgXSB8fCBwcm9jZXNzLmVudi5EWU5BTU9EQl9UQUJMRV9QUkVGSVggfHwgdW5kZWZpbmVkO1xuICAgIHRhYmxlID0gdGFibGVQcmVmaXggPyBgJHt0YWJsZVByZWZpeH0ke3RhYmxlfWAgOiB0YWJsZTtcbiAgICB0cnkge1xuICAgICAgICBjb25zdCBwYWdlID0gYXdhaXQgYXdzZHluYW1vZGIucXVlcnlJbmRleCh0YWJsZSwge1trZXldOiBjdHgucXVlcnkuZmlsZX0sIGluZGV4KTtcbiAgICAgICAgaWYgKCFwYWdlIHx8ICFwYWdlLml0ZW1zIHx8ICFwYWdlLml0ZW1zLmxlbmd0aCkgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgY29uc3QgZGF0YSA9IHBhZ2UuaXRlbXNbMF07XG4gICAgICAgIGlmICghZGF0YSB8fCAhZGF0YS5sb2NhdGlvbikgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgcmV0dXJuIHsuLi5kYXRhfTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoZSk7XG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxufSJdfQ==