"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require('path');
const awss3 = new (require('aws-sdk/clients/s3'));
const getFile = async ({ bucket, key, raw = false }) => {
    const f = await awss3.getObject({ Bucket: bucket, Key: key }).promise();
    return { body: (f && f.Body) ? (raw ? f.Body : f.Body.toString()) : undefined };
};
const setFile = async ({ bucket, key }, content) => awss3.putObject({ Bucket: bucket, Key: key, Body: content }).promise();
const deleteFile = async ({ bucket, key }) => awss3.deleteObject({ Bucket: bucket, Key: key }).promise();
const deleteDirectory = async ({ bucket, key }) => {
    const files = await awss3.listObjects({ Bucket: bucket, Prefix: `${key}/` }).promise();
    if (!files || !files.Contents || !files.Contents.length)
        return [];
    const objects = files.Contents.map(f => ({ Key: f.Key }));
    await awss3.deleteObjects({ Bucket: bucket, Delete: { Objects: objects } }).promise();
    return [...objects, ...(await deleteDirectory({ bucket, key }))];
};
const getFileContent = async (query) => (await getFile(query)).body;
const setFileContent = setFile;
const fromJsonFile = async (bucket, key) => JSON.parse(await getFileContent({ bucket, key }));
const toJsonFile = async (bucket, key, data) => setFileContent({ bucket, key }, JSON.stringify(data));
const getFileUploadUrl = async ({ bucket, key, expires = 60 }) => new Promise((resolve, reject) => {
    awss3.createPresignedPost({ Bucket: bucket, Expires: parseInt(expires), Fields: { key } }, (err, data) => {
        if (err) {
            reject(err);
        }
        else {
            resolve({
                uploadUrl: data['url'],
                fileUrl: `${data['url']}/${key}`,
                fields: JSON.stringify(data['fields']),
            });
        }
    });
});
const getFileDownloadUrl = async ({ bucket, key, name }) => {
    const fileName = name || path.basename(key);
    const url = await awss3.getSignedUrlPromise('getObject', {
        Bucket: bucket,
        Key: key,
        ResponseContentDisposition: `attachment; filename="${fileName}"`,
    });
    return {
        downloadUrl: url,
        fileUrl: url,
        fields: JSON.stringify({}),
        fileName,
    };
};
const getFileViewUrl = async ({ bucket, key, contentType }) => {
    const url = await awss3.getSignedUrlPromise('getObject', {
        Bucket: bucket,
        Key: key,
        ...(contentType ? { ResponseContentType: contentType } : {}),
        ResponseContentDisposition: 'inline',
    });
    return {
        viewUrl: url,
        fileUrl: url,
        fields: JSON.stringify({}),
        contentType,
    };
};
exports.s3 = {
    deleteFile,
    deleteDirectory,
    getFile,
    getFileContent,
    getFileUploadUrl,
    getFileDownloadUrl,
    getFileViewUrl,
    fromJsonFile,
    toJsonFile,
    setFile,
    setFileContent,
};
exports.default = exports.s3;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiczMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvc2VydmljZXMvczMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxNQUFNLElBQUksR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDN0IsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDLENBQUM7QUFFbEQsTUFBTSxPQUFPLEdBQUcsS0FBSyxFQUFFLEVBQUMsTUFBTSxFQUFFLEdBQUcsRUFBRSxHQUFHLEdBQUcsS0FBSyxFQUFDLEVBQUUsRUFBRTtJQUNqRCxNQUFNLENBQUMsR0FBRyxNQUFNLEtBQUssQ0FBQyxTQUFTLENBQUMsRUFBQyxNQUFNLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUMsQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDO0lBQ3RFLE9BQU8sRUFBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLEVBQUMsQ0FBQztBQUNsRixDQUFDLENBQUM7QUFFRixNQUFNLE9BQU8sR0FBRyxLQUFLLEVBQUUsRUFBQyxNQUFNLEVBQUUsR0FBRyxFQUFDLEVBQUUsT0FBTyxFQUFFLEVBQUUsQ0FDN0MsS0FBSyxDQUFDLFNBQVMsQ0FBQyxFQUFDLE1BQU0sRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFDLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FDdkU7QUFDRCxNQUFNLFVBQVUsR0FBRyxLQUFLLEVBQUUsRUFBQyxNQUFNLEVBQUUsR0FBRyxFQUFDLEVBQUUsRUFBRSxDQUN2QyxLQUFLLENB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QUFZO0lBQ1osVUFBVTtJQUNWLE9BQU87SUFDUCxjQUFjO0NBQ2pCLENBQUE7QUFFRCxrQkFBZSxVQUFFLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3QgYXdzczMgPSBuZXcgKHJlcXVpcmUoJ2F3cy1zZGsvY2xpZW50cy9zMycpKTtcblxuY29uc3QgZ2V0RmlsZSA9IGFzeW5jICh7YnVja2V0LCBrZXksIHJhdyA9IGZhbHNlfSkgPT4ge1xuICAgIGNvbnN0IGYgPSBhd2FpdCBhd3NzMy5nZXRPYmplY3Qoe0J1Y2tldDogYnVja2V0LCBLZXk6IGtleX0pLnByb21pc2UoKTtcbiAgICByZXR1cm4ge2JvZHk6IChmICYmIGYuQm9keSkgPyAocmF3ID8gZi5Cb2R5IDogZi5Cb2R5LnRvU3RyaW5nKCkpIDogdW5kZWZpbmVkfTtcbn07XG5cbmNvbnN0IHNldEZpbGUgPSBhc3luYyAoe2J1Y2tldCwga2V5fSwgY29udGVudCkgPT5cbiAgICBhd3NzMy5wdXRPYmplY3Qoe0J1Y2tldDogYnVja2V0LCBLZXk6IGtleSwgQm9keTogY29udGVudH0pLnByb21pc2UoKVxuO1xuY29uc3QgZGVsZXRlRmlsZSA9IGFzeW5jICh7YnVja2V0LCBrZXl9KSA9PlxuICAgIGF3c3MzLmRlbGV0ZU9iamVjdCh7QnVja2V0OiBidWNrZXQsIEtleToga2V5fSkucHJvbWlzZSgpXG47XG5cbmNvbnN0IGRlbGV0ZURpcmVjdG9yeSA9IGFzeW5jICh7YnVja2V0LCBrZXl9KSA9PiB7XG4gICAgY29uc3QgZmlsZXMgPSBhd2FpdCBhd3NzMy5saXN0T2JqZWN0cyh7QnVja2V0OiBidWNrZXQsIFByZWZpeDogYCR7a2V5fS9gfSkucHJvbWlzZSgpO1xuICAgIGlmICghZmlsZXMgfHwgIWZpbGVzLkNvbnRlbnRzIHx8ICFmaWxlcy5Db250ZW50cy5sZW5ndGgpIHJldHVybiBbXTtcbiAgICBjb25zdCBvYmplY3RzOiB7S2V5OiBzdHJpbmd9W10gPSBmaWxlcy5Db250ZW50cy5tYXAoZiA9PiAoe0tleTogZi5LZXl9KSk7XG4gICAgYXdhaXQgYXdzczMuZGVsZXRlT2JqZWN0cyh7QnVja2V0OiBidWNrZXQsIERlbGV0ZToge09iamVjdHM6IG9iamVjdHN9fSkucHJvbWlzZSgpO1xuICAgIHJldHVybiBbLi4ub2JqZWN0cywgLi4uKGF3YWl0IGRlbGV0ZURpcmVjdG9yeSh7YnVja2V0LCBrZXl9KSldO1xufTtcblxuY29uc3QgZ2V0RmlsZUNvbnRlbnQgPSBhc3luYyBxdWVyeSA9PiAoYXdhaXQgZ2V0RmlsZShxdWVyeSkpLmJvZHk7XG5jb25zdCBzZXRGaWxlQ29udGVudCA9IHNldEZpbGU7XG5cbmNvbnN0IGZyb21Kc29uRmlsZSA9IGFzeW5jIChidWNrZXQsIGtleSkgPT4gSlNPTi5wYXJzZShhd2FpdCBnZXRGaWxlQ29udGVudCh7YnVja2V0LCBrZXl9KSk7XG5jb25zdCB0b0pzb25GaWxlID0gYXN5bmMgKGJ1Y2tldCwga2V5LCBkYXRhKSA9PiBzZXRGaWxlQ29udGVudCh7YnVja2V0LCBrZXl9LCBKU09OLnN0cmluZ2lmeShkYXRhKSk7XG5cbmNvbnN0IGdldEZpbGVVcGxvYWRVcmwgPSBhc3luYyAoe2J1Y2tldCwga2V5LCBleHBpcmVzID0gNjB9KSA9PiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgYXdzczMuY3JlYXRlUHJlc2lnbmVkUG9zdChcbiAgICAgICAge0J1Y2tldDogYnVja2V0LCBFeHBpcmVzOiBwYXJzZUludCg8YW55PmV4cGlyZXMpLCBGaWVsZHM6IHtrZXl9fSxcbiAgICAgICAgKGVyciwgZGF0YSkgPT4ge1xuICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgIHJlamVjdChlcnIpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXNvbHZlKHtcbiAgICAgICAgICAgICAgICAgICAgdXBsb2FkVXJsOiBkYXRhWyd1cmwnXSxcbiAgICAgICAgICAgICAgICAgICAgZmlsZVVybDogYCR7ZGF0YVsndXJsJ119LyR7a2V5fWAsXG4gICAgICAgICAgICAgICAgICAgIGZpZWxkczogSlNPTi5zdHJpbmdpZnkoZGF0YVsnZmllbGRzJ10pLFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgKTtcbn0pO1xuXG5jb25zdCBnZXRGaWxlRG93bmxvYWRVcmwgPSBhc3luYyAoe2J1Y2tldCwga2V5LCBuYW1lfSkgPT4ge1xuICAgIGNvbnN0IGZpbGVOYW1lID0gbmFtZSB8fCBwYXRoLmJhc2VuYW1lKGtleSk7XG4gICAgY29uc3QgdXJsID0gYXdhaXQgYXdzczMuZ2V0U2lnbmVkVXJsUHJvbWlzZSgnZ2V0T2JqZWN0Jywge1xuICAgICAgICBCdWNrZXQ6IGJ1Y2tldCxcbiAgICAgICAgS2V5OiBrZXksXG4gICAgICAgIFJlc3BvbnNlQ29udGVudERpc3Bvc2l0aW9uOiBgYXR0YWNobWVudDsgZmlsZW5hbWU9XCIke2ZpbGVOYW1lfVwiYCxcbiAgICB9KTtcbiAgICByZXR1cm4ge1xuICAgICAgICBkb3dubG9hZFVybDogdXJsLFxuICAgICAgICBmaWxlVXJsOiB1cmwsXG4gICAgICAgIGZpZWxkczogSlNPTi5zdHJpbmdpZnkoe30pLFxuICAgICAgICBmaWxlTmFtZSxcbiAgICB9XG59O1xuXG5jb25zdCBnZXRGaWxlVmlld1VybCA9IGFzeW5jICh7YnVja2V0LCBrZXksIGNvbnRlbnRUeXBlfSkgPT4ge1xuICAgIGNvbnN0IHVybCA9IGF3YWl0IGF3c3MzLmdldFNpZ25lZFVybFByb21pc2UoJ2dldE9iamVjdCcsIHtcbiAgICAgICAgQnVja2V0OiBidWNrZXQsXG4gICAgICAgIEtleToga2V5LFxuICAgICAgICAuLi4oY29udGVudFR5cGUgPyB7UmVzcG9uc2VDb250ZW50VHlwZTogY29udGVudFR5cGV9IDoge30pLFxuICAgICAgICBSZXNwb25zZUNvbnRlbnREaXNwb3NpdGlvbjogJ2lubGluZScsXG4gICAgfSk7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgdmlld1VybDogdXJsLFxuICAgICAgICBmaWxlVXJsOiB1cmwsXG4gICAgICAgIGZpZWxkczogSlNPTi5zdHJpbmdpZnkoe30pLFxuICAgICAgICBjb250ZW50VHlwZSxcbiAgICB9XG59O1xuXG5leHBvcnQgY29uc3QgczMgPSB7XG4gICAgZGVsZXRlRmlsZSxcbiAgICBkZWxldGVEaXJlY3RvcnksXG4gICAgZ2V0RmlsZSxcbiAgICBnZXRGaWxlQ29udGVudCxcbiAgICBnZXRGaWxlVXBsb2FkVXJsLFxuICAgIGdldEZpbGVEb3dubG9hZFVybCxcbiAgICBnZXRGaWxlVmlld1VybCxcbiAgICBmcm9tSnNvbkZpbGUsXG4gICAgdG9Kc29uRmlsZSxcbiAgICBzZXRGaWxlLFxuICAgIHNldEZpbGVDb250ZW50LFxufVxuXG5leHBvcnQgZGVmYXVsdCBzMyJdfQ==