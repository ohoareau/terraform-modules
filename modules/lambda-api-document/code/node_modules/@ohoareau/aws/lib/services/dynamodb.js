"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const awsdb = new (require('aws-sdk/clients/dynamodb').DocumentClient);
const buildTableName = name => `${process.env[`DYNAMODB_${name.toUpperCase()}_TABLE_PREFIX`] || process.env.DYNAMODB_TABLE_PREFIX || ''}${name}${process.env[`DYNAMODB_${name.toUpperCase()}_TABLE_SUFFIX`] || process.env.DYNAMODB_TABLE_SUFFIX || ''}`;
const buildReturns = returns => {
    returns = {
        values: 'NONE',
        consumedCapacity: 'NONE',
        itemCollectionMetrics: 'NONE',
        valuesOnConditionCheckFailure: 'NONE',
        ...(returns || {}),
    };
    return {
        ReturnValues: returns.values,
        ReturnConsumedCapacity: returns.consumedCapacity,
        ReturnItemCollectionMetrics: returns.itemCollectionMetrics,
        ReturnValuesOnConditionCheckFailure: returns.valuesOnConditionCheckFailure,
    };
};
const buildOperationString = (v, kk, i) => {
    if ('object' === typeof v) {
        const { type, ...params } = v;
        const vv = `:v${i}`;
        switch (type) {
            case 'beginsWith': return [[[vv, params.value]], `begins_with(${kk}, ${vv})`];
            case 'eq': return [[[vv, params.value]], `${kk} = ${vv}`];
            case 'lt': return [[[vv, params.value]], `${kk} < ${vv}`];
            case 'le': return [[[vv, params.value]], `${kk} <= ${vv}`];
            case 'gt': return [[[vv, params.value]], `${kk} > ${vv}`];
            case 'ge': return [[[vv, params.value]], `${kk} >= ${vv}`];
            case 'between': return [[[`${vv}a`, params.lowerBound], [`${vv}b`, params.upperBound]], `${kk} BETWEEN ${vv}a AND ${vv}b`];
        }
    }
    return [[[`:v${i}`, v]], `${kk} = :v${i}`];
};
const buildParams = (table, key, returns = undefined, extra = {}) => ({ TableName: buildTableName(table), Key: key, ...buildReturns(returns), ...extra });
const buildExpressionParams = (filter, prefix, first, between, operationMode = true) => (!filter || !Object.keys(filter).length)
    ? {}
    : Object.entries(filter).reduce((acc, [k, v], i) => {
        const kk = `#K${i}`;
        const [vvv, op] = operationMode ? buildOperationString(v, kk, i) : [[[`:v${i}`, v]], `${kk} = :v${i}`];
        acc.ExpressionAttributeNames[kk] = k;
        vvv.forEach(vv => {
            acc.ExpressionAttributeValues[vv[0]] = vv[1];
        });
        acc[`${prefix}Expression`] = `${acc[`${prefix}Expression`] || ''}${acc[`${prefix}Expression`] ? between : first}${op}`;
        return acc;
    }, { ExpressionAttributeNames: {}, ExpressionAttributeValues: {}, [`${prefix}Expression`]: undefined });
const buildUpdateParams = (table, key, data, returns = undefined) => ({
    ...buildParams(table, key, returns),
    ...buildExpressionParams(data, 'Update', 'SET ', ', ', false),
});
const buildQueryParams = (table, key, index = undefined) => ({
    TableName: buildTableName(table),
    ...(index ? { IndexName: index } : {}),
    ...buildExpressionParams(key, 'KeyCondition', '', ' and '),
});
const buildScanParams = (table, filter = {}, index = undefined) => ({
    TableName: buildTableName(table),
    ...(index ? { IndexName: index } : {}),
    ...buildExpressionParams(filter, 'Filter', '', ' and '),
});
const mutateReadResult = r => ({
    items: r.Items,
    count: r.Count,
    scannedCount: r.ScannedCount,
    consumedCapacity: r.ConsumedCapacity,
    itemCollectionMetrics: r.ItemCollectionMetrics,
});
const mutateWriteResult = r => ({
    attributes: r.Attributes,
    consumedCapacity: r.ConsumedCapacity,
    itemCollectionMetrics: r.ItemCollectionMetrics,
});
exports.dynamodb = {
    delete: async (table, key, returns = undefined) => mutateWriteResult(await awsdb.delete(buildParams(table, key, returns)).promise()),
    upsert: async (table, key, data, returns = undefined) => mutateWriteResult(await awsdb.update(buildUpdateParams(table, key, data, returns)).promise()),
    queryIndex: async (table, index, key) => mutateReadResult(await awsdb.query(buildQueryParams(table, key, index)).promise()),
    query: async (table, key) => mutateReadResult(await awsdb.query(buildQueryParams(table, key)).promise()),
    scanIndex: async (table, index, filter = {}) => mutateReadResult(await awsdb.scan(buildScanParams(table, filter, index)).promise()),
    scan: async (table, filter = {}) => mutateReadResult(await awsdb.scan(buildScanParams(table, filter)).promise()),
};
exports.default = exports.dynamodb;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHluYW1vZGIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvc2VydmljZXMvZHluYW1vZGIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLDBCQUEwQixDQUFDLENBQUMsY0FBYyxDQUFDLENBQUM7QUFFdkUsTUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDLEVBQUUsQ0FBQyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWSxJQUFJLENBQUMsV0FBVyxFQUFFLGVBQWUsQ0FBQyxJQUFJLE9BQU8sQ0FBQyxHQUFHLENBQUMscUJBQXFCLElBQUksRUFBRSxHQUFHLElBQUksR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFlBQVksSUFBSSxDQUFDLFdBQVcsRUFBRSxlQUFlLENBQUMsSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLHFCQUFxQixJQUFJLEVBQUUsRUFBRSxDQUFDO0FBQ3pQLE1BQU0sWUFBWSxHQUFHLE9BQU8sQ0FBQyxFQUFFO0lBQzNCLE9BQU8sR0FBRztRQUNOLE1BQU0sRUFBRSxNQUFNO1FBQ2QsZ0JBQWdCLEVBQUUsTUFBTTtRQUN4QixxQkFBcUIsRUFBRSxNQUFNO1FBQzdCLDZCQUE2QixFQUFFLE1BQU07UUFDckMsR0FBRyxDQUFDLE9BQU8sSUFBSSxFQUFFLENBQUM7S0FDckIsQ0FBQztJQUNGLE9BQU87UUFDSCxZQUFZLEVBQUUsT0FBTyxDQUFDLE1BQU07UUFDNUIsc0JBQXNCLEVBQUUsT0FBTyxDQUFDLGdCQUFnQjtRQUNoRCwyQkFBMkIsRUFBRSxPQUFPLENBQUMscUJBQXFCO1FBQzFELG1DQUFtQyxFQUFFLE9BQU8sQ0FBQyw2QkFBNkI7S0FDN0UsQ0FBQztBQUNOLENBQUMsQ0FBQztBQUNGLE1BQU0sb0JBQW9CLEdBQUcsQ0FBQyxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsRUFBRSxFQUFFO0lBQ3RDLElBQUksUUFBUSxLQUFLLE9BQU8sQ0FBQyxFQUFFO1FBQ3ZCLE1BQU0sRUFBQyxJQUFJLEVBQUUsR0FBRyxNQUFNLEVBQUMsR0FBRyxDQUFDLENBQUM7UUFDNUIsTUFBTSxFQUFFLEdBQUcsS0FBSyxDQUFDLEVBQUUsQ0FBQztRQUNwQixRQUFRLElBQUksRUFBRTtZQUNWLEtBQUssWUFBWSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsZUFBZSxFQUFFLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQztZQUM5RSxLQUFLLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLEdBQUcsRUFBRSxNQUFNLEVBQUUsRUFBRSxDQUFDLENBQUM7WUFDMUQsS0FBSyxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxHQUFHLEVBQUUsTUFBTSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBQzFELEtBQUssSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsR0FBRyxFQUFFLE9BQU8sRUFBRSxFQUFFLENBQUMsQ0FBQztZQUMzRCxLQUFLLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLEdBQUcsRUFBRSxNQUFNLEVBQUUsRUFBRSxDQUFDLENBQUM7WUFDMUQsS0FBSyxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxHQUFHLEVBQUUsT0FBTyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBQzNELEtBQUssU0FBUyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FB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SyxDQUFDLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQUNuSSxJQUFJLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxNQUFNLEdBQUcsRUFBRSxFQUFFLEVBQUUsQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLEtBQUssQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLEtBQUssRUFBRSxNQUFNLENBQUMsQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDO0NBQ25ILENBQUE7QUFFRCxrQkFBZSxnQkFBUSxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgYXdzZGIgPSBuZXcgKHJlcXVpcmUoJ2F3cy1zZGsvY2xpZW50cy9keW5hbW9kYicpLkRvY3VtZW50Q2xpZW50KTtcblxuY29uc3QgYnVpbGRUYWJsZU5hbWUgPSBuYW1lID0+IGAke3Byb2Nlc3MuZW52W2BEWU5BTU9EQl8ke25hbWUudG9VcHBlckNhc2UoKX1fVEFCTEVfUFJFRklYYF0gfHwgcHJvY2Vzcy5lbnYuRFlOQU1PREJfVEFCTEVfUFJFRklYIHx8ICcnfSR7bmFtZX0ke3Byb2Nlc3MuZW52W2BEWU5BTU9EQl8ke25hbWUudG9VcHBlckNhc2UoKX1fVEFCTEVfU1VGRklYYF0gfHwgcHJvY2Vzcy5lbnYuRFlOQU1PREJfVEFCTEVfU1VGRklYIHx8ICcnfWA7XG5jb25zdCBidWlsZFJldHVybnMgPSByZXR1cm5zID0+IHtcbiAgICByZXR1cm5zID0ge1xuICAgICAgICB2YWx1ZXM6ICdOT05FJyxcbiAgICAgICAgY29uc3VtZWRDYXBhY2l0eTogJ05PTkUnLFxuICAgICAgICBpdGVtQ29sbGVjdGlvbk1ldHJpY3M6ICdOT05FJyxcbiAgICAgICAgdmFsdWVzT25Db25kaXRpb25DaGVja0ZhaWx1cmU6ICdOT05FJyxcbiAgICAgICAgLi4uKHJldHVybnMgfHwge30pLFxuICAgIH07XG4gICAgcmV0dXJuIHtcbiAgICAgICAgUmV0dXJuVmFsdWVzOiByZXR1cm5zLnZhbHVlcyxcbiAgICAgICAgUmV0dXJuQ29uc3VtZWRDYXBhY2l0eTogcmV0dXJucy5jb25zdW1lZENhcGFjaXR5LFxuICAgICAgICBSZXR1cm5JdGVtQ29sbGVjdGlvbk1ldHJpY3M6IHJldHVybnMuaXRlbUNvbGxlY3Rpb25NZXRyaWNzLFxuICAgICAgICBSZXR1cm5WYWx1ZXNPbkNvbmRpdGlvbkNoZWNrRmFpbHVyZTogcmV0dXJucy52YWx1ZXNPbkNvbmRpdGlvbkNoZWNrRmFpbHVyZSxcbiAgICB9O1xufTtcbmNvbnN0IGJ1aWxkT3BlcmF0aW9uU3RyaW5nID0gKHYsIGtrLCBpKSA9PiB7XG4gICAgaWYgKCdvYmplY3QnID09PSB0eXBlb2Ygdikge1xuICAgICAgICBjb25zdCB7dHlwZSwgLi4ucGFyYW1zfSA9IHY7XG4gICAgICAgIGNvbnN0IHZ2ID0gYDp2JHtpfWA7XG4gICAgICAgIHN3aXRjaCAodHlwZSkge1xuICAgICAgICAgICAgY2FzZSAnYmVnaW5zV2l0aCc6IHJldHVybiBbW1t2diwgcGFyYW1zLnZhbHVlXV0sIGBiZWdpbnNfd2l0aCgke2trfSwgJHt2dn0pYF07XG4gICAgICAgICAgICBjYXNlICdlcSc6IHJldHVybiBbW1t2diwgcGFyYW1zLnZhbHVlXV0sIGAke2trfSA9ICR7dnZ9YF07XG4gICAgICAgICAgICBjYXNlICdsdCc6IHJldHVybiBbW1t2diwgcGFyYW1zLnZhbHVlXV0sIGAke2trfSA8ICR7dnZ9YF07XG4gICAgICAgICAgICBjYXNlICdsZSc6IHJldHVybiBbW1t2diwgcGFyYW1zLnZhbHVlXV0sIGAke2trfSA8PSAke3Z2fWBdO1xuICAgICAgICAgICAgY2FzZSAnZ3QnOiByZXR1cm4gW1tbdnYsIHBhcmFtcy52YWx1ZV1dLCBgJHtra30gPiAke3Z2fWBdO1xuICAgICAgICAgICAgY2FzZSAnZ2UnOiByZXR1cm4gW1tbdnYsIHBhcmFtcy52YWx1ZV1dLCBgJHtra30gPj0gJHt2dn1gXTtcbiAgICAgICAgICAgIGNhc2UgJ2JldHdlZW4nOiByZXR1cm4gW1tbYCR7dnZ9YWAsIHBhcmFtcy5sb3dlckJvdW5kXSwgW2Ake3Z2fWJgLCBwYXJhbXMudXBwZXJCb3VuZF1dLCBgJHtra30gQkVUV0VFTiAke3Z2fWEgQU5EICR7dnZ9YmBdO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiBbW1tgOnYke2l9YCwgdl1dLCBgJHtra30gPSA6diR7aX1gXTtcbn07XG5jb25zdCBidWlsZFBhcmFtcyA9ICh0YWJsZSwga2V5LCByZXR1cm5zOiBhbnkgPSB1bmRlZmluZWQsIGV4dHJhID0ge30pID0+ICh7VGFibGVOYW1lOiBidWlsZFRhYmxlTmFtZSh0YWJsZSksIEtleToga2V5LCAuLi5idWlsZFJldHVybnMocmV0dXJucyksIC4uLmV4dHJhfSk7XG5jb25zdCBidWlsZEV4cHJlc3Npb25QYXJhbXMgPSAoZmlsdGVyLCBwcmVmaXgsIGZpcnN0LCBiZXR3ZWVuLCBvcGVyYXRpb25Nb2RlID0gdHJ1ZSkgPT5cbiAgICAoIWZpbHRlciB8fCAhT2JqZWN0LmtleXMoZmlsdGVyKS5sZW5ndGgpXG4gICAgICAgID8ge31cbiAgICAgICAgOiBPYmplY3QuZW50cmllcyhmaWx0ZXIpLnJlZHVjZSgoYWNjLCBbaywgdl0sIGkpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGtrID0gYCNLJHtpfWA7XG4gICAgICAgICAgICBjb25zdCBbdnZ2LCBvcF0gPSBvcGVyYXRpb25Nb2RlID8gYnVpbGRPcGVyYXRpb25TdHJpbmcodiwga2ssIGkpIDogW1tbYDp2JHtpfWAsIHZdXSwgYCR7a2t9ID0gOnYke2l9YF07XG4gICAgICAgICAgICBhY2MuRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzW2trXSA9IGs7XG4gICAgICAgICAgICAoPGFueVtdPnZ2dikuZm9yRWFjaCh2diA9PiB7XG4gICAgICAgICAgICAgICAgYWNjLkV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXNbdnZbMF1dID0gdnZbMV07XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGFjY1tgJHtwcmVmaXh9RXhwcmVzc2lvbmBdID0gYCR7YWNjW2Ake3ByZWZpeH1FeHByZXNzaW9uYF0gfHwgJyd9JHthY2NbYCR7cHJlZml4fUV4cHJlc3Npb25gXSA/IGJldHdlZW4gOiBmaXJzdH0ke29wfWA7XG4gICAgICAgICAgICByZXR1cm4gYWNjO1xuICAgICAgICB9LCB7RXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzOiB7fSwgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczoge30sIFtgJHtwcmVmaXh9RXhwcmVzc2lvbmBdOiB1bmRlZmluZWR9KVxuO1xuY29uc3QgYnVpbGRVcGRhdGVQYXJhbXMgPSAodGFibGUsIGtleSwgZGF0YSwgcmV0dXJuczogYW55ID0gdW5kZWZpbmVkKSA9PiAoe1xuICAgIC4uLmJ1aWxkUGFyYW1zKHRhYmxlLCBrZXksIHJldHVybnMpLFxuICAgIC4uLmJ1aWxkRXhwcmVzc2lvblBhcmFtcyhkYXRhLCAnVXBkYXRlJywgJ1NFVCAnLCAnLCAnLCBmYWxzZSksXG59KTtcblxuY29uc3QgYnVpbGRRdWVyeVBhcmFtcyA9ICh0YWJsZSwga2V5LCBpbmRleCA9IHVuZGVmaW5lZCkgPT4gKHtcbiAgICBUYWJsZU5hbWU6IGJ1aWxkVGFibGVOYW1lKHRhYmxlKSxcbiAgICAuLi4oaW5kZXggPyB7SW5kZXhOYW1lOiBpbmRleH0gOiB7fSksXG4gICAgLi4uYnVpbGRFeHByZXNzaW9uUGFyYW1zKGtleSwgJ0tleUNvbmRpdGlvbicsICcnLCAnIGFuZCAnKSxcbn0pO1xuY29uc3QgYnVpbGRTY2FuUGFyYW1zID0gKHRhYmxlLCBmaWx0ZXIgPSB7fSwgaW5kZXggPSB1bmRlZmluZWQpID0+ICh7XG4gICAgVGFibGVOYW1lOiBidWlsZFRhYmxlTmFtZSh0YWJsZSksXG4gICAgLi4uKGluZGV4ID8ge0luZGV4TmFtZTogaW5kZXh9IDoge30pLFxuICAgIC4uLmJ1aWxkRXhwcmVzc2lvblBhcmFtcyhmaWx0ZXIsICdGaWx0ZXInLCAnJywgJyBhbmQgJyksXG59KTtcbmNvbnN0IG11dGF0ZVJlYWRSZXN1bHQgPSByID0+ICh7XG4gICAgaXRlbXM6IHIuSXRlbXMsXG4gICAgY291bnQ6IHIuQ291bnQsXG4gICAgc2Nhbm5lZENvdW50OiByLlNjYW5uZWRDb3VudCxcbiAgICBjb25zdW1lZENhcGFjaXR5OiByLkNvbnN1bWVkQ2FwYWNpdHksXG4gICAgaXRlbUNvbGxlY3Rpb25NZXRyaWNzOiByLkl0ZW1Db2xsZWN0aW9uTWV0cmljcyxcbn0pO1xuY29uc3QgbXV0YXRlV3JpdGVSZXN1bHQgPSByID0+ICh7XG4gICAgYXR0cmlidXRlczogci5BdHRyaWJ1dGVzLFxuICAgIGNvbnN1bWVkQ2FwYWNpdHk6IHIuQ29uc3VtZWRDYXBhY2l0eSxcbiAgICBpdGVtQ29sbGVjdGlvbk1ldHJpY3M6IHIuSXRlbUNvbGxlY3Rpb25NZXRyaWNzLFxufSk7XG5leHBvcnQgY29uc3QgZHluYW1vZGIgPSB7XG4gICAgZGVsZXRlOiBhc3luYyAodGFibGUsIGtleSwgcmV0dXJuczogYW55ID0gdW5kZWZpbmVkKSA9PiBtdXRhdGVXcml0ZVJlc3VsdChhd2FpdCBhd3NkYi5kZWxldGUoYnVpbGRQYXJhbXModGFibGUsIGtleSwgcmV0dXJucykpLnByb21pc2UoKSksXG4gICAgdXBzZXJ0OiBhc3luYyAodGFibGUsIGtleSwgZGF0YSwgcmV0dXJuczogYW55ID0gdW5kZWZpbmVkKSA9PiBtdXRhdGVXcml0ZVJlc3VsdChhd2FpdCBhd3NkYi51cGRhdGUoYnVpbGRVcGRhdGVQYXJhbXModGFibGUsIGtleSwgZGF0YSwgcmV0dXJucykpLnByb21pc2UoKSksXG4gICAgcXVlcnlJbmRleDogYXN5bmMgKHRhYmxlLCBpbmRleCwga2V5KSA9PiBtdXRhdGVSZWFkUmVzdWx0KGF3YWl0IGF3c2RiLnF1ZXJ5KGJ1aWxkUXVlcnlQYXJhbXModGFibGUsIGtleSwgaW5kZXgpKS5wcm9taXNlKCkpLFxuICAgIHF1ZXJ5OiBhc3luYyAodGFibGUsIGtleSkgPT4gbXV0YXRlUmVhZFJlc3VsdChhd2FpdCBhd3NkYi5xdWVyeShidWlsZFF1ZXJ5UGFyYW1zKHRhYmxlLCBrZXkpKS5wcm9taXNlKCkpLFxuICAgIHNjYW5JbmRleDogYXN5bmMgKHRhYmxlLCBpbmRleCwgZmlsdGVyID0ge30pID0+IG11dGF0ZVJlYWRSZXN1bHQoYXdhaXQgYXdzZGIuc2NhbihidWlsZFNjYW5QYXJhbXModGFibGUsIGZpbHRlciwgaW5kZXgpKS5wcm9taXNlKCkpLFxuICAgIHNjYW46IGFzeW5jICh0YWJsZSwgZmlsdGVyID0ge30pID0+IG11dGF0ZVJlYWRSZXN1bHQoYXdhaXQgYXdzZGIuc2NhbihidWlsZFNjYW5QYXJhbXModGFibGUsIGZpbHRlcikpLnByb21pc2UoKSksXG59XG5cbmV4cG9ydCBkZWZhdWx0IGR5bmFtb2RiIl19